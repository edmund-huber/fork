#  Second Step - Experimental Fork Compiler
#  Copyright (C) Marco Cilloni <marco.cilloni@yahoo.com> 2014
#
#  This Source Code Form is subject to the terms of the Mozilla Public
#  License, v. 2.0. If a copy of the MPL was not distributed with this
#  file, You can obtain one at http://mozilla.org/MPL/2.0/.
#  Exhibit B is not attached; this software is compatible with the
#  licenses expressed under Section 1.12 of the MPL v2.


import ast
import ctx
import sema
import spring
import utils


func validateBreakContinue(rsv sema:Resolver,
                           stmt ptr ast:PNode,
                           inLoop bool,
                           errors ptr spring:List) bool

  if !inLoop
    spring:listAppend(errors, utils:issueNew(utils:ISSUE_ERR, stmt'begin, rsv'root'fileName, "break or continue outside of a loop"))

    return false
  /if

  return true
/func


func validateStmt(rsv sema:Resolver,
                  stmt ptr ast:PNode,
                  funcInfo ast:Symbol,
                  inLoop bool,
                  errors ptr spring:List) bool

  if ast:pnodeIsBreakContinue(stmt)
    return validateBreakContinue(rsv, stmt, inLoop, errors)
  /if

  if ast:pnodeIsDecl(stmt)

  /if

  if ast:pnodeIsExpr(stmt)

  /if

  if ast:pnodeIsIf(stmt)

  /if

  if ast:pnodeIsReturn(stmt)

  /if

  if ast:pnodeIsWhile(stmt)

  /if

  # unreachable
  spring:errln("unknown statement type")
  spring:abort()
  return false
/func


func validatePBlock(rsv sema:Resolver,
                    pblock ptr ast:PBlock,
                    funcInfo ast:Symbol,
                    inLoop bool,
                    errors ptr spring:List) bool

  mut len = spring:listLen(pblock'node'leaves)
  mut i uintptr = 0

  while i < len
    mut stmt = cast<ptr ast:PNode>(val spring:listGet(pblock'node'leaves, i))

    if !validateStmt(rsv, stmt, funcInfo, inLoop, errors)
      return false
    /if

    i++
  /while

  return true
/func


func validateFunc(rsv sema:Resolver,
                  pdecl ptr ast:PDecl,
                  funcType ptr ast:Type,
                  errors ptr spring:List) bool

  mut sym ast:Symbol

  sym'type = funcType
  sym'name = pdecl'sym'name

  mut pblock = cast<ptr ast:PBlock>(val spring:listGet(pdecl'node'leaves, 0))

  return validatePBlock(rsv, pblock, sym, false, errors)
/func
